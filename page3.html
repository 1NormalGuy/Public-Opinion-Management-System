<script>
    // 加载 JSON 数据并初始化页面
    async function loadData() {
        try {
            const response = await fetch('data.json');
            const data = await response.json();

            // 初始化数据
            const entityData = data.entityData;
            const relationshipData = data.relationshipData;
            const eventData = data.eventData;
            const eventHeatData = data.eventHeatData;
            const eventSentimentData = data.eventSentimentData;

            // 调用初始化函数
            renderEntityTable(entityData);
            renderKnowledgeGraph(relationshipData);
            renderEventHeatChart(eventData, eventHeatData);
            renderEventSentimentChart(eventData, eventSentimentData);
            attachButtonEvents();
        } catch (error) {
            console.error("数据加载失败：", error);
        }
    }

    // 页面加载完成后调用
    document.addEventListener("DOMContentLoaded", loadData);

    // 更新实体表格函数
    function renderEntityTable(entityData) {
        const entityTableBody = document.querySelector('#entity-recognition table tbody');
        entityTableBody.innerHTML = '';

        entityData.forEach(entity => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${entity.category}</td>
                            <td>${entity.name}</td>
                            <td>${entity.frequency}</td>`;
            entityTableBody.appendChild(tr);
        });

        // 更新最常提到的实体
        const topEntities = entityData.reduce((acc, entity) => {
            if (!acc[entity.category] || acc[entity.category].frequency < entity.frequency) {
                acc[entity.category] = entity;
            }
            return acc;
        }, {});

        const sampleDataDiv = document.querySelector('#entity-recognition .sample-data');
        sampleDataDiv.innerHTML = `<p><strong>最常提到的实体：</strong></p>`;
        for (const category in topEntities) {
            const entity = topEntities[category];
            sampleDataDiv.innerHTML += `<p>${category}：${entity.name}（${entity.frequency}次）</p>`;
        }
    }

    // 更新知识图谱函数
    function renderKnowledgeGraph(relationshipData) {
        const container = document.getElementById('knowledge-graph');
        container.innerHTML = '';

        const width = container.clientWidth;
        const height = container.clientHeight;

        const svg = d3.select(container)
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const categories = {
            "人物": { color: "#1e90ff" },
            "组织": { color: "#ff6347" },
            "地点": { color: "#32cd32" },
            "政策事件": { color: "#ffa500" }
        };

        const simulation = d3.forceSimulation(relationshipData.nodes)
            .force("link", d3.forceLink(relationshipData.links).id(d => d.id).distance(150))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(relationshipData.links)
            .enter().append("line")
            .attr("stroke-width", 2)
            .attr("stroke", "#00e5ff");

        const node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(relationshipData.nodes)
            .enter().append("circle")
            .attr("r", 10)
            .attr("fill", d => categories[d.category] ? categories[d.category].color : "#ffffff")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        const labels = svg.append("g")
            .attr("class", "labels")
            .selectAll("text")
            .data(relationshipData.nodes)
            .enter().append("text")
            .attr("dy", -15)
            .attr("text-anchor", "middle")
            .attr("fill", "#00e5ff")
            .text(d => d.id);

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            labels
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }

    // 热度图
    function renderEventHeatChart(eventData, eventHeatData) {
        const chartDom = document.getElementById('event-heat-chart');
        const myChart = echarts.init(chartDom);
        const events = eventData.map(event => event.name);
        const series = eventData.map(event => ({
            name: event.name,
            type: 'line',
            data: eventHeatData[event.name],
            smooth: true
        }));

        const option = {
            title: { text: '事件热度图', textStyle: { color: '#00e5ff' } },
            xAxis: { type: 'category', data: ['2017', '2018', '2019', '2020', '2021', '2022', '2023', '2024'] },
            yAxis: { type: 'value' },
            series: series
        };

        myChart.setOption(option);
    }

    // 情感图
    function renderEventSentimentChart(eventData, eventSentimentData) {
        const chartDom = document.getElementById('event-sentiment-chart');
        const myChart = echarts.init(chartDom);
        const option = {
            title: { text: '事件情感分析', textStyle: { color: '#00e5ff' } },
            legend: { data: ['正面', '负面', '中性'] },
            xAxis: { type: 'category', data: eventData.map(event => event.name) },
            yAxis: { type: 'value' },
            series: [
                { name: '正面', type: 'bar', data: eventData.map(e => eventSentimentData[e.name].positive) },
                { name: '负面', type: 'bar', data: eventData.map(e => eventSentimentData[e.name].negative) },
                { name: '中性', type: 'bar', data: eventData.map(e => eventSentimentData[e.name].neutral) }
            ]
        };

        myChart.setOption(option);
    }
</script>
